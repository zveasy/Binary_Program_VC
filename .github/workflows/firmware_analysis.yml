name: Firmware Analysis Pipeline

on: [push]

jobs:
  analyze_firmware:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install angr  # üî• Ensure angr is installed

      - name: Install Graphviz
        run: |
          sudo apt-get update
          sudo apt-get install -y graphviz

      - name: Run Firmware Analysis (Infinite Loop Test)
        run: |
          python3 rda_disassembler_enhanced.py firmware/infinite_loop_test.bin
          if grep -q "\[ALERT\] Potential infinite loops detected" firmware/disassembly.log; then
            echo "‚úÖ Infinite loop correctly detected."
          else
            echo "::error::‚ùå Infinite loop NOT detected when expected!"
            exit 1
          fi

      - name: Run Firmware Analysis (Hello World Test)
        run: |
          python3 rda_disassembler_enhanced.py firmware/hello_world_test.bin
          if grep -q "\[ALERT\] Potential infinite loops detected" firmware/disassembly.log; then
            echo "::error::‚ùå Unexpected infinite loop detected in hello world binary."
            exit 1
          else
            echo "‚úÖ No infinite loops detected (expected)."
          fi

      - name: Convert CFG DOT to PNG
        run: |
          for dotfile in cfg_*.dot; do
            dot -Tpng "$dotfile" -o "${dotfile%.dot}.png"
          done

      - name: Check for Infinite Loops
        run: |
          if grep -q "[ALERT] Potential infinite loops detected" firmware/disassembly.log; then
            echo "::error::Infinite loops detected! Check log for details."
            exit 1
          else
            echo "‚úÖ No infinite loops detected."
          fi

      - name: Upload CFG Images
        uses: actions/upload-artifact@v4
        with:
          name: cfg-images
          path: "*.png"

      - name: Upload Disassembly Log
        uses: actions/upload-artifact@v4
        with:
          name: disassembly-log
          path: firmware/disassembly.log